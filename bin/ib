#!/usr/bin/env ruby
# -*- coding: utf-8 -*-
# vim: filetype=ruby

self_file =
  if File.symlink?(__FILE__)
    require 'pathname'
    Pathname.new(__FILE__).realpath
  else
    __FILE__
  end
$:.unshift(File.dirname(self_file) + "/../lib")

require 'immutablebox'

tracker = 'http://localhost:6969/announce'
priv = true
name = File.basename(FileUtils.pwd)
IB_DIR_GAP = "#{IB_DIR}/gap"
IB_DIR_TORRENTS = "#{IB_DIR}/torrents/#{name}"
IB_DIR_PIECES = "#{IB_DIR}/pieces"
storage = LocalStorage.new(IB_DIR_PIECES)

command = (ARGV.shift or 'help').to_sym
case command
when :commit, :ci
  img = make_torrent(name, '.', tracker, priv)
  torrentfile = "#{IB_DIR_TORRENTS}/#{Time.now.to_i}.torrent"
  File.open(torrentfile, 'wb') do |fd|
    fd.write(img)
  end
  begin
    storage.open
    load_torrent(torrentfile) do |piece_hash, piece|
      storage.store(piece_hash, piece)
    end
  ensure
    storage.close
  end
when :init
  FileUtils.mkdir_p IB_DIR_GAP
  FileUtils.mkdir_p IB_DIR_TORRENTS
  FileUtils.mkdir_p IB_DIR_PIECES
when :log
  Dir.entries(IB_DIR_TORRENTS).each do |dir|
    next unless /\.torrent\z/ === dir
    puts Time.at(dir.split.first.to_i)
  end
when :status, :st
  torrent = Dir.entries(IB_DIR_TORRENTS).sort_by{|dir| dir.split.first.to_i}
  torrent = File.join(IB_DIR_TORRENTS, torrent.last)
  begin
    storage.open
    changes = load_torrent(torrent) do |piece_hash, piece|
    end
    changes.each do |file|
      puts file
    end
    # TODO show new and removed files
  ensure
    storage.close
  end
when :update, :up
  p :update
when :verify
  p :verify
else
  p :help
end
